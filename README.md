# taskUpdate

## Скрипт для добавления/изменения наблюдателей в задаче
***
Данный скрипт написан по просьбе руководителя одного из отделов нашей компании.

**Файлы.**

**`init.php`** - для коробки (`/bitrix/php_interface/init.php`)

**`rest_handler.php`** - для Rest.

**Принцип действия.**

Если при постановке задачи назначается ответственным руководитель нужного отдела, то в наблюдатели добавляются все остальные сотрудники этого отдела. Если руководитель делегирует свою задачу кому-то из подчинённых, то он автоматически становится наблюдателем

**Реализация.**

Сначала я написал коробочное решение с помощью  Bitrix API, однако после после добавления на боевой портал, весь КП начал сильно тормозить (по крайней мере у меня). Поэтому я адаптировал его под Rest, в итоге всё заработало нормально. Если будете использовать Rest-версию, вам понадобится [php-класс CRest для выполнения запросов](https://github.com/bitrix-tools/crest).

Данное решение может быть модифицировано для любого отдела, а не только для указанного в параметрах вызова. Для этого вам потребуется поменять местами запросы в массиве ```$batch```, чтобы сначала шёл `tasks.task.list`, а также добавить ещё один метод `user.get`, чтобы получить ID подразделения, в котором работает пользователь.

В таком случае массив ```$batch``` будет выглядеть следующим образом:

``` php

$batch = [
    'get_task' => [
        'method' => 'tasks.task.get',
        'params' => [
            'taskId' => $taskID,
            'select' => ['ID', 'RESPONSIBLE_ID', 'AUDITORS']
        ]
    ],
    'get_user' => [
        'method' => 'user.get',
        'params' => [
            'FILTER' => [
                "ID" => '$result[get_task][task][responsibleId]'
            ]
        ]
    ],
    'get_users' => [
        'method' => 'user.get',
        'params' => [
            'FILTER' => [
                "UF_DEPARTMENT" => '$result[get_user][0][UF_DEPARTMENT][0]',
                'ACTIVE' => true
            ]
        ]
    ]
];

```

Дальнейшее выполнение скрипта без изменений.

**Вебхуки**

Если вы используете Rest, вам нужно будет сгенерировать 3 вебхука: 1 входящий и 2 исходящих (создание и изменение задачи). Входящему вебхуку нужно дать следующие права:

* Задачи (task)
* Задачи (расширенные права) (tasks_extended)
* Пользователи (user)

На этом всё. Если нужна помощь по настройке скрипта, а также настройке вашего Битрикс24, пишите в [телеграм](https://t.me/ramapriya_doom).
